{"title":"Kubernetes 多节点快速部署","slug":"2025-9-15","date":"2025-09-14T16:00:00.000Z","updated":"2025-12-15T02:12:43.666Z","comments":true,"path":"api/articles/2025-9-15.json","excerpt":null,"covers":null,"content":"<p><strong>目标环境：Ubuntu 20.04 | 3 Master + 2 Worker | keepalived + haproxy VIP(推荐，此处未写) | 容器运行时 containerd</strong></p>\n<h2 id=\"1-节点规划（企业级-IP-分配）\"><a href=\"#1-节点规划（企业级-IP-分配）\" class=\"headerlink\" title=\"1 节点规划（企业级 IP 分配）\"></a>1 节点规划（企业级 IP 分配）</h2><table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>物理 IP</th>\n<th>角色</th>\n<th>组件</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>k8s-m1</td>\n<td><code>10.10.50.11/24</code></td>\n<td>Master-1</td>\n<td>kube-apiserver, etcd, controller-manager, scheduler</td>\n</tr>\n<tr>\n<td>k8s-m2</td>\n<td><code>10.10.50.12/24</code></td>\n<td>Master-2</td>\n<td>同上</td>\n</tr>\n<tr>\n<td>k8s-m3</td>\n<td><code>10.10.50.13/24</code></td>\n<td>Master-3</td>\n<td>同上</td>\n</tr>\n<tr>\n<td>k8s-n1</td>\n<td><code>10.10.50.21/24</code></td>\n<td>Worker-1</td>\n<td>kubelet, containerd</td>\n</tr>\n<tr>\n<td>k8s-n2</td>\n<td><code>10.10.50.22/24</code></td>\n<td>Worker-2</td>\n<td>同上</td>\n</tr>\n<tr>\n<td><strong>VIP</strong></td>\n<td><code>10.10.50.30/24</code></td>\n<td>浮动 IP</td>\n<td><code>keepalived</code> 漂移地址，供 HAProxy 监听</td>\n</tr>\n</tbody></table>\n<p><strong>企业网络策略确认：</strong></p>\n<ul>\n<li>DHCP 已排除 <code>10.10.50.11-13</code>, <code>.21-22</code>, <code>.30</code></li>\n<li>防火墙白名单放行所有节点间端口</li>\n<li><strong>重点：VIP 的 MAC 地址将使用 VRRP 虚拟 MAC，需管理员绑定该 MAC 到交换机端口</strong></li>\n</ul>\n<h2 id=\"2️-所有节点基础配置\"><a href=\"#2️-所有节点基础配置\" class=\"headerlink\" title=\"2️ 所有节点基础配置\"></a>2️ 所有节点基础配置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 2.1 更新系统 &amp; 安装必要工具</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt update &amp;&amp; <span class=\"built_in\">sudo</span> apt upgrade -y</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt install -y \\</span><br><span class=\"line\">    apt-transport-https ca-certificates curl gnupg lsb-release chrony net-tools vim</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.2 关闭 swap 和防火墙</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> swapoff -a</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> sed -i <span class=\"string\">&#x27;/ swap / s/^/#/&#x27;</span> /etc/fstab</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> ufw <span class=\"built_in\">disable</span> || <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.3 时间同步（使用阿里云 NTP 服务器）</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> sed -i <span class=\"string\">&#x27;/^pool\\|^server/c\\server ntp.aliyun.com iburst&#x27;</span> /etc/chrony/chrony.conf</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl <span class=\"built_in\">enable</span> --now chronyd  <span class=\"comment\"># 使用正确服务名 chronyd.service</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>使用<code>sealos</code>快速部署</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sealos run registry.cn-shanghai.aliyuncs.com/labring/kubernetes:v1.29.9 \\</span><br><span class=\"line\">  registry.cn-shanghai.aliyuncs.com/labring/helm:v3.9.4 \\</span><br><span class=\"line\">  registry.cn-shanghai.aliyuncs.com/labring/cilium:v1.13.4 \\</span><br><span class=\"line\">  --masters 172.18.51.112,172.18.51.137,172.18.51.173 \\</span><br><span class=\"line\">  --nodes 172.18.51.51,172.18.51.28</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl taint nodes --all node-role.kubernetes.io/control-plane-</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n","more":"<p><strong>目标环境：Ubuntu 20.04 | 3 Master + 2 Worker | keepalived + haproxy VIP(推荐，此处未写) | 容器运行时 containerd</strong></p>\n<h2 id=\"1-节点规划（企业级-IP-分配）\"><a href=\"#1-节点规划（企业级-IP-分配）\" class=\"headerlink\" title=\"1 节点规划（企业级 IP 分配）\"></a>1 节点规划（企业级 IP 分配）</h2><table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>物理 IP</th>\n<th>角色</th>\n<th>组件</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>k8s-m1</td>\n<td><code>10.10.50.11/24</code></td>\n<td>Master-1</td>\n<td>kube-apiserver, etcd, controller-manager, scheduler</td>\n</tr>\n<tr>\n<td>k8s-m2</td>\n<td><code>10.10.50.12/24</code></td>\n<td>Master-2</td>\n<td>同上</td>\n</tr>\n<tr>\n<td>k8s-m3</td>\n<td><code>10.10.50.13/24</code></td>\n<td>Master-3</td>\n<td>同上</td>\n</tr>\n<tr>\n<td>k8s-n1</td>\n<td><code>10.10.50.21/24</code></td>\n<td>Worker-1</td>\n<td>kubelet, containerd</td>\n</tr>\n<tr>\n<td>k8s-n2</td>\n<td><code>10.10.50.22/24</code></td>\n<td>Worker-2</td>\n<td>同上</td>\n</tr>\n<tr>\n<td><strong>VIP</strong></td>\n<td><code>10.10.50.30/24</code></td>\n<td>浮动 IP</td>\n<td><code>keepalived</code> 漂移地址，供 HAProxy 监听</td>\n</tr>\n</tbody></table>\n<p><strong>企业网络策略确认：</strong></p>\n<ul>\n<li>DHCP 已排除 <code>10.10.50.11-13</code>, <code>.21-22</code>, <code>.30</code></li>\n<li>防火墙白名单放行所有节点间端口</li>\n<li><strong>重点：VIP 的 MAC 地址将使用 VRRP 虚拟 MAC，需管理员绑定该 MAC 到交换机端口</strong></li>\n</ul>\n<h2 id=\"2️-所有节点基础配置\"><a href=\"#2️-所有节点基础配置\" class=\"headerlink\" title=\"2️ 所有节点基础配置\"></a>2️ 所有节点基础配置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 2.1 更新系统 &amp; 安装必要工具</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt update &amp;&amp; <span class=\"built_in\">sudo</span> apt upgrade -y</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt install -y \\</span><br><span class=\"line\">    apt-transport-https ca-certificates curl gnupg lsb-release chrony net-tools vim</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.2 关闭 swap 和防火墙</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> swapoff -a</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> sed -i <span class=\"string\">&#x27;/ swap / s/^/#/&#x27;</span> /etc/fstab</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> ufw <span class=\"built_in\">disable</span> || <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.3 时间同步（使用阿里云 NTP 服务器）</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> sed -i <span class=\"string\">&#x27;/^pool\\|^server/c\\server ntp.aliyun.com iburst&#x27;</span> /etc/chrony/chrony.conf</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> systemctl <span class=\"built_in\">enable</span> --now chronyd  <span class=\"comment\"># 使用正确服务名 chronyd.service</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>使用<code>sealos</code>快速部署</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sealos run registry.cn-shanghai.aliyuncs.com/labring/kubernetes:v1.29.9 \\</span><br><span class=\"line\">  registry.cn-shanghai.aliyuncs.com/labring/helm:v3.9.4 \\</span><br><span class=\"line\">  registry.cn-shanghai.aliyuncs.com/labring/cilium:v1.13.4 \\</span><br><span class=\"line\">  --masters 172.18.51.112,172.18.51.137,172.18.51.173 \\</span><br><span class=\"line\">  --nodes 172.18.51.51,172.18.51.28</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl taint nodes --all node-role.kubernetes.io/control-plane-</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n","categories":[{"name":"运维","path":"api/categories/运维.json"}],"tags":[{"name":"教程","path":"api/tags/教程.json"}]}